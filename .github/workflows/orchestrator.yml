# .github/workflows/pr-checks.yml
name: 'Checks'

on:
  pull_request:
    branches:
      - 'main'
      - 'release/**'
  merge_group:

concurrency:
  group: '${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}'
  cancel-in-progress: true

permissions:
  contents: 'read'
  packages: 'write'
  pull-requests: 'write'
  security-events: 'write'
  checks: 'write'
  statuses: 'write'
  actions: 'read'
  attestations: 'read'
  deployments: 'read'
  discussions: 'read'
  issues: 'read'
  pages: 'read'
  repository-projects: 'read'
  id-token: 'write'

jobs:
  lint:
    name: 'Lint'
    uses: './.github/workflows/lint.yml'

  build-and-publish:
    name: 'Build and Publish CI Bundle'
    needs: 'lint'
    uses: './.github/workflows/build-and-publish.yml'

  ci:
    name: 'CI Checks'
    needs: 'lint'
    uses: './.github/workflows/ci.yml'

  get-vars:
    name: 'Get Environment Variables'
    runs-on: 'ubuntu-latest'
    environment: 'dev'
    outputs:
      cli-package-name: '${{ steps.get-vars.outputs.cli-package-name }}'
    steps:
      - id: 'get-vars'
        run: 'echo ''cli-package-name=''''${{ vars.CLI_PACKAGE_NAME }}'''''' >> "$GITHUB_OUTPUT"'

  build-sandbox:
    name: 'Build Sandbox Image'
    needs: 'lint'
    uses: './.github/workflows/build-sandbox.yml'
    with:
      github-actor: '${{ github.actor }}'
      github-secret: '${{ github.token }}'
      github-sha: '${{ github.sha }}'
      github-ref-name: '${{ github.ref_name }}'
      dry-run: false
      npm-registry-scope: '${{ vars.NPM_REGISTRY_SCOPE }}'
      npm-registry-url: '${{ vars.NPM_REGISTRY_URL }}'
      cli-package-name: '${{ vars.CLI_PACKAGE_NAME }}'

  e2e:
    name: 'E2E Checks'
    needs: ['build-and-publish', 'get-vars', 'build-sandbox']
    uses: './.github/workflows/e2e.yml'
    with:
      version: '${{ needs.build-and-publish.outputs.version }}'
      cli-package-name: '${{ needs.get-vars.outputs.cli-package-name }}'
      image-uri: '${{ needs.build-sandbox.outputs.image-uri }}'
    secrets:
      GEMINI_API_KEY: '${{ secrets.GEMINI_API_KEY }}'

  bundle-size:
    name: 'Bundle Size Check'
    needs: 'build-and-publish'
    uses: './.github/workflows/bundle-size.yml'
    with:
      version: '${{ needs.build-and-publish.outputs.version }}'
